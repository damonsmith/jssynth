<html>
    <head>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
        <link href="css/app.css" rel="stylesheet">
        <title>Jsynth Demo</title>
        <script src="./js/thirdParty/jquery-1.9.1.min.js" type="text/javascript"></script>
        <script src="../../js/JSSynth.js" type="text/javascript"></script>
        <script src="../../js/JSWebAudioOutput.js" type="text/javascript"></script>
        <script src="./js/SongPlayer.js" type="text/javascript"></script>
        <script src="./js/EffectHandlers.js" type="text/javascript"></script>
        <script src="./js/MODLoader.js" type="text/javascript"></script>
        <script src="./js/S3MLoader.js" type="text/javascript"></script>
        <!--<script src="./mods/klisje.mod.js" type="text/javascript"></script>-->
        <script src="./s3ms/lavender.s3m.js" type="text/javascript"></script>
    </head>
    <title>Pure javascript / Web Audio MOD player</title>
<body>
<script>
//    song = jssynth.MOD.readMODfile(module);
    song = jssynth.S3M.readS3Mfile(module);
    player = new jssynth.MOD.Player(song, 4); /* 4 extra channels reserved for FX/game noises etc */
    audioOut = new jssynth.WebAudioOutput(player.getMixer());
</script>
    <div class="songDetails">
        <div class="row"><div class="header songName">Song Name:</div><div class="value songName">-</div></div>
        <div class="row"><div class="header songType">Song Type:</div><div class="value songType">M.K.</div></div>
        <div class="row"><div class="header songChannels">Num channels:</div><div class="value songChannels">4</div></div>
        <div class="row"><div class="header songLength">Song length:</div><div class="value songLength">0</div></div>
    </div>
    <div class="playerDetails">
        <div class="row"><div class="header songSpeed">Speed:</div><div class="value songSpeed">6/125</div></div>
        <div class="row"><div class="header songPos">Position: </div><div class="value songPos">0/0</div></div>
    </div>
    <div class="controls">
        <button type="button" onclick="player.previousPos();">&lt;&lt;</button>
        <button type="button" onclick="audioOut.start();">Start</button>
        <button type="button" onclick="audioOut.stop();">Stop</button>
        <button type="button" onclick="player.nextPos();">&gt;&gt;</button>
        <button type="button" onclick="player.playerState.filter = 1 - player.playerState.filter">Toggle filter</button>
        <!--<button type="button" onclick="player.loggingEnabled = !player.loggingEnabled">Toggle debug</button>-->
    </div>
    <div class="song-pattern-container"></div>
<script>
var getDummyRow = function(song) {
    var dummyRow = $('<tr></tr>').addClass('pattern-row');
    dummyRow.append($('<th></th>').addClass('pattern-row-num').text('-'));
    for (var chan = 0; chan < song.channels; chan++) {
        dummyRow.append($('<td></td>').addClass('pattern-data').text('--- -- -- - --'));
    }
    return dummyRow;
}

var createPatternView = function(song, patternNumber) {
    var pattern = song.patterns[patternNumber];
    var patternTable = $('<table></table>').addClass('scrollable song-pattern hidden').addClass('pattern-'+patternNumber);
    var patternTableBody = $('<tbody></tbody>');

    for (var row = 0; row < 64; row++) {
        var rowHtml = $('<tr></tr>').addClass('pattern-row row-num-'+row);
        if (row % 2 == 1) {
            rowHtml.addClass('alternate-row');
        }
        rowHtml.append($('<th></th>').addClass('pattern-row-num').text(''+row));
        for (var chan = 0; chan < song.channels; chan++) {
            var note = pattern[row][chan];

            var text = "";
            if (note.note > 0) {
                text = text + jssynth.MOD.MOD_PERIOD_TABLE.getName(note.note) + " ";
            } else {
                text = text + "--- "
            }
            if (note.sampleNumber > 0) {
                text = text + ("0"+note.sampleNumber.toString(16)).slice(-2) + " ";
            } else {
                text = text + "-- "
            }
            if (note.volume > 0) {
                text = text + ("0"+note.volume.toString(16)).slice(-2) + " ";
            } else {
                text = text + "-- "
            }

            text = text + song.effectMap[note.effect].code + " ";
            text = text + ("0"+note.parameter.toString(16)).slice(-2);

            rowHtml.append($('<td></td>').addClass('pattern-data').text(text));
        }
        patternTableBody.append(rowHtml);
    }

    patternTable.append(patternTableBody);

    return patternTable;
}

$(document).ready(function(){
    for (var i = 0; i < song.patterns.length; i++) {
        $('.song-pattern-container').append(createPatternView(song, i));
    }
    $('.song-pattern.pattern-'+song.orders[0]).removeClass('hidden');
    $('.song-pattern.pattern-0').removeClass('hidden');

    $('.value.songName').text(song.name);
    $('.value.songType').text(song.type);
    $('.value.songChannels').text(song.channels);
    $('.value.songLength').text(song.songLength);

    var songPatternContainerSelector = $('.song-pattern-container');
    var previousVisiblePattern = 0;
    var previousPlayingRow = 0;
    var patternSelectors = [];
    for (var i = 0; i < song.patterns.length; i++) {
        patternSelectors[i] = $('.song-pattern.pattern-'+i);
    }
    var songSpeedSelector = $('.value.songSpeed');
    var songPosSelector = $('.value.songPos');

    player.registerCallback(function(playerState, channelStateArray) {

        if (playerState.tick === 0) {
            if (playerState.row === 0) {
                patternSelectors[previousVisiblePattern].addClass('hidden');
                patternSelectors[song.orders[playerState.pos]].removeClass('hidden');
            }
            patternSelectors[previousVisiblePattern].find('tr.row-num-'+previousPlayingRow).removeClass('playing');
            patternSelectors[song.orders[playerState.pos]].find('tr.row-num-'+playerState.row).addClass('playing');

            var scrollTo = patternSelectors[song.orders[playerState.pos]].find('tr.row-num-'+playerState.row);
            songPatternContainerSelector.scrollTop(scrollTo.offset().top - songPatternContainerSelector.offset().top + songPatternContainerSelector.scrollTop());

            previousVisiblePattern = song.orders[playerState.pos];
            previousPlayingRow = playerState.row;
            songSpeedSelector.text("" + playerState.speed + "/" + playerState.bpm);
            songPosSelector.text("" + playerState.pos + "/" + playerState.row);
        }
    });

});
</script>
    </body>
</html>

