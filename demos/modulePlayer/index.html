<html>
<head>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
    <link href="css/app.css" rel="stylesheet">
    <title>JSSynth Demo</title>
    <script src="./js/thirdParty/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="../../js/jssynth_core.js" type="text/javascript"></script>
    <script src="../../js/jssynth_mod.js" type="text/javascript"></script>
    <script src="../../js/jssynth_s3m.js" type="text/javascript"></script>

    <script src="./mods/ode2ptk.mod.js" type="text/javascript"></script>
    <script src="./s3ms/lavender.s3m.js" type="text/javascript"></script>
</head>
<body>
<div class="titlebar">
    <span>JSSynth demo: JavaScript+HTML5 MOD/S3M player</span>
</div>

    <span class="infoRow">
        <span class="songDetails">
            <div class="row"><div class="header songName">Song Name:</div><div class="value songName">-</div></div>
            <div class="row"><div class="header songType">Song Type:</div><div class="value songType">M.K.</div></div>
            <div class="row"><div class="header songChannels">Num channels:</div><div class="value songChannels">4</div></div>
            <div class="row"><div class="header songLength">Song length:</div><div class="value songLength">0</div></div>
        </span>
        <span class="playerDetails">
            <div class="row"><div class="header songSpeed">Speed:</div><div class="value songSpeed">6/125</div></div>
            <div class="row"><div class="header songPos">Position/Pattern: </div><div class="value songPos">0/0</div></div>
            <div class="row"><div class="header songRow">Row: </div><div class="value songRow">0</div></div>
        </span>
    </span>
    <span class="controlsRow">
        <div class="controls">
            <button class="button" type="button" onclick="audioOut.start();">Play</button>
            <button class="button" type="button" onclick="audioOut.stop();">|&nbsp;|</button>
            <button class="button" type="button" onclick="player.previousPos();">&lt;&lt;</button>
            <button class="button" type="button" onclick="player.nextPos();">&gt;&gt;</button>
            <button class="button" type="button" onclick="player.playerState.filter = 1 - player.playerState.filter">Toggle filter</button>
        </div>
    </span>
<div class="clear"/>
<div class="song-pattern-container"></div>
<script>
    var getDummyRow = function(song) {
        var dummyRow = $('<tr></tr>').addClass('pattern-row');
        dummyRow.append($('<th></th>').addClass('pattern-row-num').text('-'));
        for (var chan = 0; chan < song.channels; chan++) {
            dummyRow.append($('<td></td>').addClass('pattern-data').text('--- -- -- - --'));
        }
        return dummyRow;
    }

    var createPatternView = function(song, patternNumber) {
        var pattern = song.patterns[patternNumber];
        var patternTable = $('<table></table>').addClass('scrollable song-pattern hidden').addClass('pattern-'+patternNumber);
        var patternTableBody = $('<tbody></tbody>');

        for (var row = 0; row < pattern.length; row++) {
            var rowHtml = $('<tr></tr>').addClass('pattern-row row-num-'+row);
            if (row % 2 == 1) {
                rowHtml.addClass('alternate-row');
            }
            rowHtml.append($('<th></th>').addClass('pattern-row-num').text(''+row));
            for (var chan = 0; chan < song.channels; chan++) {
                var note = pattern[row][chan];

                var text = "";
                if (note.note > 0) {
                    text = text + jssynth_mod.MOD_PERIOD_TABLE.getName(note.note) + " ";
                } else {
                    text = text + "--- ";
                }
                if (note.sampleNumber > 0) {
                    text = text + ("0"+note.sampleNumber.toString(16)).slice(-2) + " ";
                } else {
                    text = text + "-- ";
                }
                if (note.volume > 0) {
                    text = text + ("0"+note.volume.toString(16)).slice(-2) + " ";
                } else {
                    text = text + "-- ";
                }

                if (note.parameter === 0x00 && note.effect === 0x00) {
                    text = text + "- ";
                } else {
                    if (song.effectMap[note.effect]) {
                        text = text + song.effectMap[note.effect].code + " ";
                    } else {
                        text = text + "X" + ("0"+note.effect.toString(16)).slice(-2) + " ";
                    }
                }

                if (note.parameter === 0x00 && note.effect === 0x00) {
                    text = text + "--";
                } else {
                    text = text + ("0"+note.parameter.toString(16)).slice(-2);
                }

                rowHtml.append($('<td></td>').addClass('pattern-data').text(text));
            }
            patternTableBody.append(rowHtml);
        }

        patternTable.append(patternTableBody);

        return patternTable;
    }

    window.onload = function(){
        song = jssynth_mod.readMODfile(window['assets/mod/ode2ptk']);
    //    song = jssynth_s3m.readS3Mfile(window['assets/s3m/lavender']);

        mixer = new jssynth_core.Mixer({numChannels: 16 /* 10 for music, 2 for effects */ });
        player = new jssynth_mod.Player(this.mixer);
        player.setSong(this.song);
        audioOut = new jssynth_core.WebAudioOutput(this.mixer, 4096);  /* 4096/8192/.. = buffer size */

        for (var i = 0; i < song.patterns.length; i++) {
            $('.song-pattern-container').append(createPatternView(song, i));
        }
        $('.song-pattern.pattern-'+song.orders[0]).removeClass('hidden');
        $('.song-pattern.pattern-0').removeClass('hidden');

        $('.value.songName').text(song.name);
        $('.value.songType').text(song.type);
        $('.value.songChannels').text(song.channels);
        $('.value.songLength').text(song.songLength);

        var songPatternContainerSelector = $('.song-pattern-container');
        var previousVisiblePattern = 0;
        var previousPlayingRow = 0;
        var patternSelectors = [];
        for (var i = 0; i < song.patterns.length; i++) {
            patternSelectors[i] = $('.song-pattern.pattern-'+i);
        }
        var songSpeedSelector = $('.value.songSpeed');
        var songPosSelector = $('.value.songPos');
        var songRowSelector = $('.value.songRow');
        var updateTimeout;

        player.registerCallback(function(playerState, channelStateArray) {
            if (playerState.tick === 0) {
                if (updateTimeout) {
                    window.clearTimeout(updateTimeout);
                }
                updateTimeout = setTimeout(function() {
                    if (song.orders[playerState.pos] !== previousVisiblePattern) {
                        patternSelectors[previousVisiblePattern].addClass('hidden');
                        patternSelectors[song.orders[playerState.pos]].removeClass('hidden');
                    }
                    patternSelectors[previousVisiblePattern].find('tr.row-num-'+previousPlayingRow).removeClass('playing');
                    patternSelectors[song.orders[playerState.pos]].find('tr.row-num-'+playerState.row).addClass('playing');

                    var scrollTo = patternSelectors[song.orders[playerState.pos]].find('tr.row-num-'+playerState.row);
                    songPatternContainerSelector.scrollTop(scrollTo.offset().top - songPatternContainerSelector.offset().top + songPatternContainerSelector.scrollTop());

                    previousVisiblePattern = song.orders[playerState.pos];
                    previousPlayingRow = playerState.row;
                    songSpeedSelector.text("" + playerState.speed + "/" + playerState.bpm);
                    songPosSelector.text("" + playerState.pos + "/" + song.orders[playerState.pos]);
                    songRowSelector.text("" +playerState.row);
                    updateTimeout = null;
                }, 0);
            }
        });

    };
</script>
</body>
</html>

